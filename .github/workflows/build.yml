name: Build and Release (ç®€åŒ–ç‰ˆ)

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ (å¦‚ v2.1.0)
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: æ„å»ºexeæ–‡ä»¶
      id: build
      run: |
        # è®¾ç½®UTF-8ç¼–ç ç¯å¢ƒ
        chcp 65001
        $env:PYTHONIOENCODING = "utf-8"
        $env:PYTHONUTF8 = "1"
        
        # ä½¿ç”¨PyInstallerç›´æ¥æ„å»ºï¼Œé¿å…ä¸­æ–‡è·¯å¾„é—®é¢˜
        # è·å–ç‰ˆæœ¬å·
        if ("$env:GITHUB_REF" -match "refs/tags/(.*)") {
          $version = $matches[1]
        } else {
          $version = "dev-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "æ„å»ºç‰ˆæœ¬: $version"
        
        # æ„å»ºexe
        pyinstaller --name="NodeConfigConverter" --windowed --onefile --clean --distpath=dist --workpath=build yaml_to_v2rayn.py
      shell: powershell
      
    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        if (Test-Path "./dist/NodeConfigConverter.exe") {
          $size = (Get-Item "./dist/NodeConfigConverter.exe").Length
          Write-Output "âœ… exeæ–‡ä»¶æ„å»ºæˆåŠŸï¼Œå¤§å°: $([math]::Round($size/1MB, 2)) MB"
          # é‡å‘½åä¸ºæ›´å‹å¥½çš„ä¸­æ–‡å
          Copy-Item "./dist/NodeConfigConverter.exe" "./dist/èŠ‚ç‚¹è½¬æ¢å·¥å…·-${{ steps.build.outputs.version }}.exe"
        } else {
          Write-Error "âŒ exeæ–‡ä»¶æ„å»ºå¤±è´¥"
          exit 1
        }
      shell: powershell
      
    - name: åˆ›å»ºRelease
      id: create_release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: èŠ‚ç‚¹é…ç½®è½¬æ¢å·¥å…· ${{ steps.build.outputs.version }}
        body: |
          ## ğŸš€ èŠ‚ç‚¹é…ç½®è½¬æ¢å·¥å…· ${{ steps.build.outputs.version }}
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ”„ **ä¸‰å‘è½¬æ¢**ï¼šClash YAML â‡„ V2rayN é“¾æ¥ + V2Ray Config.json
          - ğŸ¨ **ç°ä»£åŒ–ç•Œé¢**ï¼šä¸‰ç§è½¬æ¢æ¨¡å¼é¢œè‰²åŒºåˆ†ï¼ˆç»¿/è“/æ©™ï¼‰
          - ğŸ§  **æ™ºèƒ½æ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«è¾“å…¥æ ¼å¼
          - ğŸ›¡ï¸ **åè®®æ”¯æŒ**ï¼šVMess, VLESS, SS, Trojan, Hysteria2
          
          ### ğŸ“¦ ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¹¶è¿è¡Œ `NodeConfigConverter.exe`
          2. é€‰æ‹©è½¬æ¢æ–¹å‘
          3. ç²˜è´´é…ç½®å†…å®¹
          4. ç‚¹å‡»è½¬æ¢å¹¶å¤åˆ¶ç»“æœ
          
          ### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
          - æ”¯æŒå¤šç§SSé“¾æ¥ç¼–ç æ ¼å¼
          - RealityåŠ å¯†æ”¯æŒ
          - WebSocketä¼ è¾“åè®®
          - æ™ºèƒ½è·¯ç”±è§„åˆ™ç”Ÿæˆ
          
          âš ï¸ **å…è´£å£°æ˜**ï¼šæœ¬å·¥å…·ä»…ä¾›å­¦ä¹ ç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ã€‚
          
          ---
          ğŸ“ è¯¦ç»†æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        files: |
          ./dist/NodeConfigConverter.exe
          ./dist/èŠ‚ç‚¹è½¬æ¢å·¥å…·-${{ steps.build.outputs.version }}.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}