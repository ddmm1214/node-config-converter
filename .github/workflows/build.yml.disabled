name: Build and Release (简化版)

on:
  push:
    tags:
      - 'v*'  # 当推送版本标签时触发 (如 v2.1.0)
  workflow_dispatch:  # 手动触发

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: 构建exe文件
      id: build
      run: |
        # 设置UTF-8编码环境
        chcp 65001
        $env:PYTHONIOENCODING = "utf-8"
        $env:PYTHONUTF8 = "1"
        
        # 使用PyInstaller直接构建，避免中文路径问题
        # 获取版本号
        if ("$env:GITHUB_REF" -match "refs/tags/(.*)") {
          $version = $matches[1]
        } else {
          $version = "dev-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "构建版本: $version"
        
        # 构建exe
        pyinstaller --name="NodeConfigConverter" --windowed --onefile --clean --distpath=dist --workpath=build yaml_to_v2rayn.py
      shell: powershell
      
    - name: 验证构建结果
      run: |
        if (Test-Path "./dist/NodeConfigConverter.exe") {
          $size = (Get-Item "./dist/NodeConfigConverter.exe").Length
          Write-Output "✅ exe文件构建成功，大小: $([math]::Round($size/1MB, 2)) MB"
          # 重命名为更友好的中文名
          Copy-Item "./dist/NodeConfigConverter.exe" "./dist/节点转换工具-${{ steps.build.outputs.version }}.exe"
        } else {
          Write-Error "❌ exe文件构建失败"
          exit 1
        }
      shell: powershell
      
    - name: 创建Release
      id: create_release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: 节点配置转换工具 ${{ steps.build.outputs.version }}
        body: |
          ## 🚀 节点配置转换工具 ${{ steps.build.outputs.version }}
          
          ### ✨ 主要功能
          - 🔄 **三向转换**：Clash YAML ⇄ V2rayN 链接 + V2Ray Config.json
          - 🎨 **现代化界面**：三种转换模式颜色区分（绿/蓝/橙）
          - 🧠 **智能检测**：自动识别输入格式
          - 🛡️ **协议支持**：VMess, VLESS, SS, Trojan, Hysteria2
          
          ### 📦 使用说明
          1. 下载并运行 `NodeConfigConverter.exe`
          2. 选择转换方向
          3. 粘贴配置内容
          4. 点击转换并复制结果
          
          ### 🔧 技术特性
          - 支持多种SS链接编码格式
          - Reality加密支持
          - WebSocket传输协议
          - 智能路由规则生成
          
          ⚠️ **免责声明**：本工具仅供学习研究使用，请遵守相关法律法规。
          
          ---
          📝 详细更新日志请查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        files: |
          ./dist/NodeConfigConverter.exe
          ./dist/节点转换工具-${{ steps.build.outputs.version }}.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}