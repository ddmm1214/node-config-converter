name: ç®€åŒ–æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        # ä½¿ç”¨è‹±æ–‡æ„å»ºè„šæœ¬é¿å…ç¼–ç é—®é¢˜
        python build_exe_en.py
        
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if ($env:GITHUB_REF -match "refs/tags/(.*)") {
          $ver = $matches[1]
        } else {
          $ver = "latest"
        }
        echo "tag=$ver" >> $env:GITHUB_OUTPUT
        echo "ç‰ˆæœ¬: $ver"
      shell: powershell
        
    - name: éªŒè¯æ„å»º
      run: |
        if (Test-Path "dist/node-converter.exe") {
          $size = (Get-Item "dist/node-converter.exe").Length / 1MB
          Write-Host "âœ… æ„å»ºæˆåŠŸ! æ–‡ä»¶å¤§å°: $([math]::Round($size, 1)) MB"
        } else {
          Write-Error "âŒ æ„å»ºå¤±è´¥"
          exit 1
        }
      shell: powershell
        
    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: èŠ‚ç‚¹é…ç½®è½¬æ¢å·¥å…· ${{ steps.version.outputs.tag }}
        body: |
          ## ğŸš€ èŠ‚ç‚¹é…ç½®è½¬æ¢å·¥å…· ${{ steps.version.outputs.tag }}
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ”„ **åŒå‘è½¬æ¢**: Clash YAML â‡„ V2rayN é“¾æ¥
          - ğŸ“„ **é…ç½®ç”Ÿæˆ**: è¾“å‡º V2Ray config.json æ ¼å¼
          - ğŸ¨ **ç°ä»£åŒ–ç•Œé¢**: ä¸‰ç§è½¬æ¢æ¨¡å¼ï¼Œé¢œè‰²åŒºåˆ†
          - ğŸ” **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«è¾“å…¥æ ¼å¼
          - ğŸ›¡ï¸ **å¤šåè®®æ”¯æŒ**: VMess, VLESS, SS, Trojan, Hysteria2
          
          ### ğŸ“¦ ä¸‹è½½å’Œä½¿ç”¨
          1. ä¸‹è½½ `node-converter.exe` æ–‡ä»¶
          2. åŒå‡»è¿è¡Œï¼ˆWindowsç³»ç»Ÿï¼‰
          3. é€‰æ‹©è½¬æ¢æ–¹å‘
          4. ç²˜è´´é…ç½®å†…å®¹å¹¶è½¬æ¢
          
          ### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
          - æ”¯æŒå¤šç§SSé“¾æ¥ç¼–ç æ ¼å¼
          - VLESS RealityåŠ å¯†æ”¯æŒ
          - WebSocket/TCPä¼ è¾“åè®®
          - æ™ºèƒ½è·¯ç”±è§„åˆ™ç”Ÿæˆ
          
          ### âš ï¸ ä½¿ç”¨é¡»çŸ¥
          æœ¬å·¥å…·ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ã€‚
          
          ---
          ğŸ“ æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹é¡¹ç›®ä¸»é¡µ
        files: |
          dist/node-converter.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}