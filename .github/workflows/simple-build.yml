name: 简化构建和发布

on:
  push:
    tags:
      - 'v*'  # 当推送版本标签时触发
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: 构建可执行文件
      run: |
        # 使用英文构建脚本避免编码问题
        python build_exe_en.py
        
    - name: 获取版本信息
      id: version
      run: |
        if ($env:GITHUB_REF -match "refs/tags/(.*)") {
          $ver = $matches[1]
        } else {
          $ver = "latest"
        }
        echo "tag=$ver" >> $env:GITHUB_OUTPUT
        echo "版本: $ver"
      shell: powershell
        
    - name: 验证构建
      run: |
        if (Test-Path "dist/node-converter.exe") {
          $size = (Get-Item "dist/node-converter.exe").Length / 1MB
          Write-Host "✅ 构建成功! 文件大小: $([math]::Round($size, 1)) MB"
        } else {
          Write-Error "❌ 构建失败"
          exit 1
        }
      shell: powershell
        
    - name: 创建Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: 节点配置转换工具 ${{ steps.version.outputs.tag }}
        body: |
          ## 🚀 节点配置转换工具 ${{ steps.version.outputs.tag }}
          
          ### ✨ 主要功能
          - 🔄 **双向转换**: Clash YAML ⇄ V2rayN 链接
          - 📄 **配置生成**: 输出 V2Ray config.json 格式
          - 🎨 **现代化界面**: 三种转换模式，颜色区分
          - 🔍 **智能检测**: 自动识别输入格式
          - 🛡️ **多协议支持**: VMess, VLESS, SS, Trojan, Hysteria2
          
          ### 📦 下载和使用
          1. 下载 `node-converter.exe` 文件
          2. 双击运行（Windows系统）
          3. 选择转换方向
          4. 粘贴配置内容并转换
          
          ### 🔧 技术特性
          - 支持多种SS链接编码格式
          - VLESS Reality加密支持
          - WebSocket/TCP传输协议
          - 智能路由规则生成
          
          ### ⚠️ 使用须知
          本工具仅供学习和研究使用，请遵守相关法律法规。
          
          ---
          📝 更多信息请查看项目主页
        files: |
          dist/node-converter.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}